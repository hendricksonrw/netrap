<!DOCTYPE html>
<html>
	<head>
		<title>NetRap</title>
		<script src="js/prototype.js"></script>
		<script src="js/netrap.js"></script>
		<script src="js/boundvalue.js"></script>
		<script src="js/jog.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css"></style>
	</head>
	<body>
		<div class="toolbar">
			<div><span>Printer:</span><select name="printer"><option value="0">A1001NCz</option></select><input type="button" id="refreshPrinters" value="R" /></div>
			<div><input type="checkbox" id="monitor" /><span label="monitor">Monitor Printer</span></div>
			<div><input type="button" id="getpos" value="Get Position" /></div>
			<div><input type="button" id="clearlog" value="Clear Log" /></div>
		</div>

		<br class="clear" />

		<table>
			<tr><td>
				<canvas id="jogXYCanvas" width="247" height="242" style="width: 247px; height: 242px; background-image: url('images/control_xy.png'); background-repeat: none; float:left;"></canvas>
				</td><td>
				<canvas id="jogZCanvas" width="59" height="242" style="width: 59px; height: 242px; background-image: url('images/control_z.png'); background-repeat: none; float:left;"></canvas>
			</td><td>
				<canvas id="jogECanvas" width="59" height="242" style="width: 59px; height: 242px; background-image: url('images/control_e.png'); background-repeat: none; float:left;"></canvas>
			</td><td>
				<textarea id="log" rows="16" cols="40" readonly="readonly"></textarea><br />
				<form id="manual_entry">
					<input type="text" id="send" style="width: 80%; float: left;" />
					<input type="submit" id="sendBtn" value="Send" />
				</form>
			</td></tr>
		</table>

		<script type="text/javascript">
			document.observe('dom:loaded', function() {
				var netrap = new netrapUplink('netrap-json');

				try {
					var jogXY = new JogXY($('jogXYCanvas'));
					var jogZ = new JogZ($('jogZCanvas'));
					var jogE = new JogE($('jogECanvas'));
				} catch (e) {
					alert(e);
				}
				
				jogXY.draw();
				jogZ.draw();
				jogE.draw();
				
				function callback_jogEvent(e) {
// 					alert(e.gcode.join("\n"));
					for (var i = 0; i < e.gcode.length; i++) {
						netrap.queueCmd(e.gcode[i]);
					}
					netrap.queueCommit();
				};
				jogXY.observe('click', callback_jogEvent);
				jogZ.observe('click', callback_jogEvent);
				jogE.observe('click', callback_jogEvent);

				$('refreshPrinters').observe('click', function() {
					netrap.refreshPrinterList();
				});
				$('getpos').observe('click', function() {
					$('log').value += "> M114\n";
					netrap.refreshPosition();
				});
				$('clearlog').observe('click', function() {
					$('log').value = "";
				});
				$('monitor').observe('change', function() {
					if (this.checked) {
						this.timer = setInterval(function() {
							netrap.refreshTemperatureList();
						}, 5000);
					}
					else {
						if (this.timer) {
							clearTimeout(this.timer);
							this.timer = undefined;
						}
					}
				});
				$('manual_entry').onsubmit = function() {
					var send = $('send');
					if (send.value) {
						send.value = send.value.toUpperCase();
						$('log').value += "> " + send.value + "\n";
						netrap.query(send.value);
					}
					send.value = "";
					return false;
				};
			});
		</script>
	</body>
</html>
