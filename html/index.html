<!DOCTYPE html>
<html>
	<head>
		<title>NetRap</title>
		<script src="js/prototype.js"></script>
		<script src="js/netrap.js"></script>
		<script src="js/boundvalue.js"></script>
		<script src="js/jog.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="icon" type="image/png" href="favicon.png">
	</head>
	<body>
		<div class="toolbar">
			<div class="printerbar" id="printerbar"><input type="button" id="refreshPrinters" value="R" /><input type="button" id="addPrinter" value="+" /></div><br />
			<div style="width: 0; overflow: visible; white-space: nowrap;" id="printername"></div><br />
			<div><input type="checkbox" id="monitor" /><span label="monitor">Monitor Printer</span></div>
			<div><input type="button" id="getpos" value="Get Pos" /></div>
			<div><input type="button" id="gettemp" value="Get Temp" /></div>
			<div><input type="button" id="turnon" value="On" style="background-color: #8D8;" /></div>
			<div><input type="button" id="turnoff" value="Off" style="background-color: #D88;" /></div>
		</div>

		<br class="clear" />
		<div class="tabs" id="tabbar">
			<div class="tabbutton" id="PrinterTabButton">Printer</div>
			<div class="tabbutton" id="FilesTabButton">Files</div>
			<div class="tabbutton" id="SliceTabButton">Slice</div>
		</div>
		<br class="clear" />
		<div class="tabcontent" id="PrinterTab" name="Printer">
			<table>
				<tr><td>
					<canvas id="jogXYCanvas" width="247" height="242" style="width: 247px; height: 242px; background-image: url('images/control_xy.png'); background-repeat: none; float:left;"></canvas>
				</td><td>
					<canvas id="jogZCanvas" width="59" height="242" style="width: 59px; height: 242px; background-image: url('images/control_z.png'); background-repeat: none; float:left;"></canvas>
				</td><td>
					<canvas id="jogECanvas" width="59" height="242" style="width: 59px; height: 242px; background-image: url('images/control_e.png'); background-repeat: none; float:left;"></canvas>
				</td><td>
					<textarea id="log" rows="16" cols="40" readonly="readonly"></textarea><br />
					<form id="manual_entry">
						<input type="text" id="send" style="width: 80%; float: left;" />
						<input type="submit" id="sendBtn" value="Send" />
						<input type="button" id="clearlog" value="Clear" />
					</form>
				</td></tr>
			</table>
		</div>
		<div class="tabcontent" id="FilesTab" name="Files">
			<input type="file" id="fileupload" multiple="multiple" />
			<ul class="FileList" id="FileList"></ul>
		</div>
		<div class="tabcontent" id="SliceTab" name="Slice">
			<em>Not implemented yet</em>
		</div>

		<script type="text/javascript">
			document.observe('dom:loaded', function() {
				var netrap = new netrapUplink('netrap-json');

				function tabActivate(n) {
	// 				alert(n);
					var tabbar = $("tabbar");
					for (var i = 0; i < tabbar.children.length; i++) {
						var regex = /^(.*)Button/.exec(tabbar.children[i].id);
						if (regex) {
							if (i == n) {
								$(regex[1]).className = "tabcontent current";
								tabbar.children[i].className = "tabbutton current";
								if (/FilesTabButton/.test(tabbar.children[i].id)) {
									netrap.refreshFileList();
								}
							}
							else {
								$(regex[1]).className = "tabcontent hidden";
								tabbar.children[i].className = "tabbutton";
							}
						}
					}
				}

				var tabbar = $("tabbar");
				for (var i = 0; i < tabbar.children.length; i++) {
					tabbar.children[i].tabindex = i;
					tabbar.children[i].observe("click", function() {
						tabActivate(this.tabindex);
					});
				}
				tabActivate(0);

				try {
					var jogXY = new JogXY($('jogXYCanvas'));
					var jogZ = new JogZ($('jogZCanvas'));
					var jogE = new JogE($('jogECanvas'));
				} catch (e) {
					alert(e);
				}

				jogXY.draw();
				jogZ.draw();
				jogE.draw();

				function callback_jogEvent(e) {
					for (var i = 0; i < e.gcode.length; i++) {
						netrap.queueCmd(e.gcode[i]);
					}
					netrap.queueCommit();
				};

				function refreshPrinterList() {
					var printerdivs = $$('#printerbar > .printer');
					for (var i = 0; i < printerdivs.length; i++) {
						$('printerbar').removeChild(printerdivs[i]);
					}
					netrap.refreshPrinterList(callback_printerEvent);
				}

				function callback_printerclick() {
					var oldcurrent = $$('#printerbar > .current')[0];
					if (oldcurrent) {
						var a = oldcurrent.className.split(" ");
						var i = a.indexOf('current');
						a.splice(i, 1);
						oldcurrent.className = a.join(" ");
					}
					this.className += " current";
					$('printername').innerHTML = this.printername;
					netrap.selectPrinter(this.printername);
				};

				function callback_printerEvent(printer) {
					var printerdiv = document.createElement('div');
					printerdiv.className = 'printer';

					var newimg = document.createElement('img');
					newimg.src = 'images/prusa_icon.png';

					printerdiv.appendChild(newimg);
					printerdiv.innerHTML += '<br />' + printer;

					printerdiv.printername = printer;
					printerdiv.observe('click', callback_printerclick);

					$('printerbar').appendChild(printerdiv);
				};

				jogXY.observe('click', callback_jogEvent);
				jogZ.observe('click', callback_jogEvent);
				jogE.observe('click', callback_jogEvent);

				$('refreshPrinters').observe('click', refreshPrinterList);
				$('getpos').observe('click', function() {
					$('log').value += "> M114\n";
					netrap.refreshPosition();
				});
				$('clearlog').observe('click', function() {
					$('log').value = "";
				});
				$('monitor').observe('change', function() {
					if (this.checked) {
						this.timer = setInterval(function() {
							netrap.refreshTemperatureList();
						}, 5000);
					}
					else {
						if (this.timer) {
							clearTimeout(this.timer);
							this.timer = undefined;
						}
					}
				});
				$('manual_entry').onsubmit = function() {
					var send = $('send');
					if (send.value) {
						send.value = send.value;
						$('log').value += "> " + send.value + "\n";
						netrap.query(send.value);
					}
					send.value = "";
					return false;
				};

				$('gettemp').observe('click', function() {
					$('log').value += "> M105\n";
					netrap.query("M105");
				});
				$('turnon').observe('click', function() {
					$('log').value += "> M80\n";
					netrap.query("M80");
				});
				$('turnoff').observe('click', function() {
					$('log').value += "> M81\n";
					netrap.query("M81");
				});

				window.setTimeout(refreshPrinterList, 100);
			});
		</script>
	</body>
</html>
